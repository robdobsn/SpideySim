class @spideyGeom

	ledInterval: 5
	steps: 0

	padInfo: [
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #0
		{ chainIdx: 0, stripIdx: 0, startPos: 0.32, endPos: 0.99, hiddenLeds: 5, reversed: true }, #1
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #2
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.7, hiddenLeds: 5, reversed: true }, #3
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #4
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #5
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #6
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #7
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #8
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #9
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #10
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #11
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #12
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #13
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #14
		{ chainIdx: 0, stripIdx: 0, startPos: 0.35, endPos: .98, hiddenLeds: 5, reversed: true }, #15
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #16
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #17
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #18
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #19
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #20
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #21
		{ chainIdx: 0, stripIdx: 0, startPos: 0.2, endPos: 1.0, hiddenLeds: 5, reversed: false }, #22
		{ chainIdx: 0, stripIdx: 0, startPos: 0.34, endPos: 0.99, hiddenLeds: 5, reversed: false }, #23
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #24
		{ chainIdx: 0, stripIdx: 0, startPos: 0.02, endPos: 0.49, hiddenLeds: 5, reversed: true }, #25
		{ chainIdx: 0, stripIdx: 0, startPos: 0.27, endPos: 1.0, hiddenLeds: 5, reversed: false }, #26
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.69, hiddenLeds: 5, reversed: true }, #27
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.52, hiddenLeds: 5, reversed: true }, #28
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.62, hiddenLeds: 5, reversed: true }, #29
		{ chainIdx: 0, stripIdx: 0, startPos: 0.02, endPos: 0.55, hiddenLeds: 5, reversed: true }, #30
		{ chainIdx: 0, stripIdx: 0, startPos: 0.38, endPos: 0.99, hiddenLeds: 5, reversed: false }, #31
		{ chainIdx: 0, stripIdx: 0, startPos: 0.33, endPos: 0.98, hiddenLeds: 5, reversed: false }, #32
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #33
		{ chainIdx: 0, stripIdx: 0, startPos: 0.37, endPos: 0.98, hiddenLeds: 5, reversed: false }, #34
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.7, hiddenLeds: 5, reversed: true }, #35
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #36
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #37
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.55, hiddenLeds: 5, reversed: true }, #38
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.68, hiddenLeds: 5, reversed: true }, #39
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.98, hiddenLeds: 5, reversed: true }, #40
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.7, hiddenLeds: 5, reversed: true }, #41
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.76, hiddenLeds: 5, reversed: true }, #42
		{ chainIdx: 0, stripIdx: 0, startPos: 0.2, endPos: 0.67, hiddenLeds: 5, reversed: true }, #43
		{ chainIdx: 0, stripIdx: 0, startPos: 0.01, endPos: 0.65, hiddenLeds: 5, reversed: true }, #44
	]

	init: ->

		# transform = "matrix(1.25,0,0,-1.25,-100,700)"

		svg = d3.select("#spideyGeom svg");
		pads = svg.selectAll("path");
		pad_centers = pads[0].map( (d, i) ->
		    # bbox = this.getBBox()
		    bbox = d.getBBox()
		    # console.log("totlen" + d.getTotalLength())
		    # console.log(d.getPointAtLength(lng)) for lng in [0..d.getTotalLength()]
		    # bbox = { left: 1, width: 22, top: 11, height: 3 }
		    # console.log(bbox)
		    return [bbox.x + bbox.width/2, bbox.y + bbox.height/2, i]
		    )

		@ledsData = pads[0].map( (d, i) =>
			pathLen = d.getTotalLength()
			if not @padInfo[i].reversed
				intv = @ledInterval
				pathStart = pathLen * @padInfo[i].startPos
				pathEnd = pathLen * @padInfo[i].endPos
			else
				intv = -@ledInterval
				pathStart = pathLen * (1 - @padInfo[i].startPos)
				pathEnd = pathLen * (1 - @padInfo[i].endPos)
			leds = ({ pt: d.getPointAtLength(pathPos), clr: '#'+Math.random().toString(16).substr(-6) } for pathPos in [pathStart..pathEnd] by intv)
			return leds
			)

		# path.style("visibility", "hidden") for path in d3.selectAll("path")
		# console.log(d3.selectAll("path").attr("d"))
		# d3.selectAll("path").each( (d, i) -> console.log(d, i))
		# d3.selectAll("path").style("visibility", "hidden")
		# d3.selectAll("path").call( (sel) -> console.log(sel))
		# d3.selectAll("path").data(data).each( (d, i) -> console.log(d, i))

		# Show the led positions for each pad
		# console.log(d3.selectAll("path").data(path_points))
		# console.log(path_points)
		@padLeds = svg.selectAll("g.padLeds")
			.data(@ledsData)
			.enter()
			.append("g")
			.attr("class","padLeds")

		@ledsSel = @padLeds.selectAll(".led")
			.data( (d,i) -> return d )

		@ledsSel
			.enter()
			.append("circle")
		 	.attr("class", "led")
		 	.attr("cx", (d) -> return d.pt.x )
		 	.attr("cy", (d) -> return d.pt.y )
		 	.attr("r", 4)
		 	.attr("fill", (d,i) -> return d.clr)


		# .style("visibility", (d,i) -> 
		# 		console.log(d)
		# 		console.log(i)
		# 		return "visible" 
		# 		)

		# console.log padLeds	
			# .attr("cx", (d, i) -> 
		 # 		console.log (i)
		 # 		return d.x 
		 # 		)
		 # 	.attr("cy", (d) -> return d.y )
		 # 	.attr("r", 3)
		 # 	.attr("fill", "blue")

		# pads
		# 	.data( (d,i) -> console.log(i))
		# svg
		# 	.selectAll("circle")
		# 	.data(path_points)
		# 	.enter()
		# 	.append("circle")
		# 	.attr("class", "start_circle")
		# 	.attr("cx", (d) -> 
		# 		return d[0] 
		# 		)
		# 	.attr("cy", (d) -> return d[1] )
		# 	.attr("r", 3)
		# 	.attr("fill", "blue")

		# svg
		# 	.selectAll("ddd")
		# 	.data(path_points)
		# 	.enter()
		# 	.append("circle")
		# 	.attr("class", "next_circle")
		# 	.attr("cx", (d) -> 
		# 		return d[2] 
		# 		)
		# 	.attr("cy", (d) -> return d[3] )
		# 	.attr("r", 3)
		# 	.attr("fill", "green")

		text = svg
			.selectAll("text")
			.data(pad_centers)
			.enter()
			.append("text")

		text
			.attr("x", (d) -> return d[0]-10 )
			.attr("y", (d) -> return d[1]+8 )
			.text((d) -> return d[2])
			.attr("font-family", "sans-serif")
			.attr("font-size", "20px")
			.attr("fill", "#DCDCDC")


		d3.timer(@stepFn)


			# .attr("transform", transform)

		# d3.selectAll("path").call( (sel) -> 
		# 	# console.log(s.attr('d')) for s in sel[0]
		# 	# sel[0].each( (d,i) -> console.log("a"))
		# 	s.style("visibility", "hidden") for s in sel[0]
			
		# 	)

		# console.log(d3.select("#path3016").attr("d"))
		return

	stepFn: =>
		@steps++
		if @steps > 1000
			return true


		for padLedsData in @ledsData
			clr = '#'+Math.random().toString(16).substr(-6)
			for ledData in padLedsData
				ledData.clr = clr

		@ledsSel.attr("fill", (d) -> return d.clr)

		return false

# runtest3 = () ->
# 	spidey = new spideyGeom()
# 	spidey.init()
